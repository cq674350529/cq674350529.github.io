<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/uploads/favicon_64.ico"><link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon_16.ico"><link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon_16.ico"><link rel="mask-icon" href="/uploads/favicon_64.ico" color="#222"><meta name="google-site-verification" content="0d4t_hprsM6xsQKeGeYaBnGc8q8SZms2YKwT0JV7R1A"><meta name="msvalidate.01" content="FC470CF968AE82F56A6EF54706074EF7"><meta name="baidu-site-verification" content="yFjlb3QBTm"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"cq674350529.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="前言前面两篇文章从局域网的角度出发，对群晖NAS设备上开放的部分服务进行了分析。而在大部分情况下，群晖NAS设备是用于远程访问的场景中，即唯一的入口是通过5000&#x2F;http(5001&#x2F;https)进行访问(暂不考虑使用QuickConnect或其他代理的情形)。因此，本篇文章将主要对HTTP请求流程和处理机制进行分析，并分享在部分套件中发现的几个安全问题。"><meta property="og:type" content="article"><meta property="og:title" content="A Journey into Synology NAS 系列四: HTTP请求流程和案例分析"><meta property="og:url" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="cq674350529&#39;s blog"><meta property="og:description" content="前言前面两篇文章从局域网的角度出发，对群晖NAS设备上开放的部分服务进行了分析。而在大部分情况下，群晖NAS设备是用于远程访问的场景中，即唯一的入口是通过5000&#x2F;http(5001&#x2F;https)进行访问(暂不考虑使用QuickConnect或其他代理的情形)。因此，本篇文章将主要对HTTP请求流程和处理机制进行分析，并分享在部分套件中发现的几个安全问题。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_http_request_example.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_http_request_example_1.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_process_flow.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_diagnosis_tool_ui.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_tcpdump_man.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_Ds_File_access_flow.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_ds_file_password_leakage.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_calendar_event_attachment.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_calendar_csrf.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_mediaserver_custom_service.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_mediaserver_dms_urls.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_audiostation_request_example.png"><meta property="og:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_audiostation_http_request.png"><meta property="article:published_time" content="2022-01-22T04:00:00.000Z"><meta property="article:modified_time" content="2022-11-24T01:52:55.071Z"><meta property="article:author" content="cq674350529"><meta property="article:tag" content="Synology"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/images/cq674350529_http_request_example.png"><link rel="canonical" href="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/","path":"2022/01/22/A-Journey-into-Synology-NAS-系列四-HTTP请求流程和案例分析/","title":"A Journey into Synology NAS 系列四: HTTP请求流程和案例分析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>A Journey into Synology NAS 系列四: HTTP请求流程和案例分析 | cq674350529's blog</title><link rel="dns-prefetch" href="waline-blog-alpha.vercel.app"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="cq674350529's blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">cq674350529's blog</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-lcdpwn"><a href="/lcdpwn/" rel="section"><i class="fa fa-fire fa-fw"></i>LCDPwn</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">HTTP请求处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">安全问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Diagnosis-Tool"><span class="nav-number">3.1.</span> <span class="nav-text">Diagnosis Tool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DS-File"><span class="nav-number">3.2.</span> <span class="nav-text">DS File</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Synology-Calendar"><span class="nav-number">3.3.</span> <span class="nav-text">Synology Calendar</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Media-Server"><span class="nav-number">3.4.</span> <span class="nav-text">Media Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Audio-Station"><span class="nav-number">3.5.</span> <span class="nav-text">Audio Station</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#One-More-Thing"><span class="nav-number">4.</span> <span class="nav-text">One More Thing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-number">6.</span> <span class="nav-text">相关链接</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="cq674350529" src="/uploads/avatar_64.jpg"><p class="site-author-name" itemprop="name">cq674350529</p><div class="site-description" itemprop="description">Talk is cheap. Show me the code.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NxNjc0MzUwNTI5" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cq674350529"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOmNxNjc0MzUwNTI5QDE2My5jb20=" title="E-Mail → mailto:cq674350529@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9jcTY3NDM1MDUyOQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;cq674350529"><i class="fab fa-twitter fa-fw"></i>Twitter</span> </span><span class="links-of-author-item"><a href="https://cq674350529.github.io/atom.xml" title="RSS → https:&#x2F;&#x2F;cq674350529.github.io&#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a></span></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cDovL3d3dy5kZXZ0dHlzMC5jb20vYmxvZy8=" title="http:&#x2F;&#x2F;www.devttys0.com&#x2F;blog&#x2F;">/dev/ttyS0</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9hemVyaWEtbGFicy5jb20vd3JpdGluZy1hcm0tYXNzZW1ibHktcGFydC0xLw==" title="https:&#x2F;&#x2F;azeria-labs.com&#x2F;writing-arm-assembly-part-1&#x2F;">Azeria Labs</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9vbGQubGl2ZW92ZXJmbG93LmNvbS9pbmRleC5odG1s" title="https:&#x2F;&#x2F;old.liveoverflow.com&#x2F;index.html">LiveOverflow</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9zY3JpcHRpbmd4c3MuZ2l0Ym9vay5pby9maXJtd2FyZS1zZWN1cml0eS10ZXN0aW5nLW1ldGhvZG9sb2d5Lw==" title="https:&#x2F;&#x2F;scriptingxss.gitbook.io&#x2F;firmware-security-testing-methodology&#x2F;">OWASP FSTM</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly93enQuYWMuY24v" title="https:&#x2F;&#x2F;wzt.ac.cn&#x2F;">CataLpa</span></li></ul></div></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cq674350529.github.io/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar_64.jpg"><meta itemprop="name" content="cq674350529"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="cq674350529's blog"><meta itemprop="description" content="Talk is cheap. Show me the code."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="A Journey into Synology NAS 系列四: HTTP请求流程和案例分析 | cq674350529's blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">A Journey into Synology NAS 系列四: HTTP请求流程和案例分析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-22 12:00:00" itemprop="dateCreated datePublished" datetime="2022-01-22T12:00:00+08:00">2022-01-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-11-24 09:52:55" itemprop="dateModified" datetime="2022-11-24T09:52:55+08:00">2022-11-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">评论：</span> <a title="waline" href="/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前面两篇文章从局域网的角度出发，对群晖<code>NAS</code>设备上开放的部分服务进行了分析。而在大部分情况下，群晖<code>NAS</code>设备是用于远程访问的场景中，即唯一的入口是通过<code>5000/http(5001/https)</code>进行访问(暂不考虑使用<code>QuickConnect</code>或其他代理的情形)。因此，本篇文章将主要对<code>HTTP</code>请求流程和处理机制进行分析，并分享在部分套件中发现的几个安全问题。</p><a id="more"></a><h3 id="HTTP请求处理流程"><a href="#HTTP请求处理流程" class="headerlink" title="HTTP请求处理流程"></a>HTTP请求处理流程</h3><p>在正常登录过程中抓取的部分请求如下，可以看到请求<code>url</code>包含<code>query.cgi</code>、<code>login.cgi</code>和<code>entry.cgi</code>等。根据群晖的开发者手册可知，与设备进行交互的大概流程如下：</p><ol><li>通过<code>query.cgi</code>获取<code>API</code>相关的信息；</li><li>通过<code>login.cgi</code>和<code>encryption.cgi</code>进行认证，获取<code>session id</code>；</li><li>通过<code>entry.cgi</code>发送请求、解析响应；</li><li>完成交互后登出。</li></ol><img src="images/cq674350529_http_request_example.png"><p>某个具体的请求示例如下，可以看到有点类似于<code>JSON-RPC</code>。对于大部分请求，其<code>url</code>均为<code>&quot;/webapi/entry.cgi&quot;</code>。在<code>POST</code> <code>data</code>部分，<code>api</code>参数表示要请求的<code>API</code>名称，<code>method</code>表示要请求的<code>API</code>中的方法，<code>version</code>表示要请求的<code>API</code>版本。</p><img src="images/cq674350529_http_request_example_1.png"><p>针对<code>API</code>请求，群晖在后端采用<code>json</code>元数据文件<code>SYNO.***.***.lib</code>来定义与<code>API</code>相关的信息，示例如下。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;SYNO.Core.PersonalNotification.Event&quot;</span>: &#123;		<span class="comment">// API名称</span></span><br><span class="line">        <span class="attr">&quot;allowUser&quot;</span>: [ <span class="string">&quot;admin.local&quot;</span>],			<span class="comment">// 哪个组可以访问该API</span></span><br><span class="line">        <span class="attr">&quot;appPriv&quot;</span>: <span class="string">&quot;&quot;</span>,			</span><br><span class="line">        <span class="attr">&quot;authLevel&quot;</span>: <span class="number">1</span>,					<span class="comment">// 是否需要认证 (0表示无需认证)</span></span><br><span class="line">        <span class="attr">&quot;disableSocket&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;lib&quot;</span>: <span class="string">&quot;lib/SYNO.Core.PersonalNotification.so&quot;</span>,	<span class="comment">// 处理具体请求的文件</span></span><br><span class="line">        <span class="attr">&quot;maxVersion&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;methods&quot;</span>: &#123;					<span class="comment">// API中支持的方法以及对应的版本</span></span><br><span class="line">            <span class="attr">&quot;1&quot;</span>: [&#123;</span><br><span class="line">                    <span class="attr">&quot;fire&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;allowUser&quot;</span>: [ <span class="string">&quot;admin.local&quot;</span>,<span class="string">&quot;normal.local&quot;</span> ],	<span class="comment">// 覆盖上面的定义</span></span><br><span class="line">                        <span class="attr">&quot;grantByUser&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;grantable&quot;</span>: <span class="literal">true</span> &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;minVersion&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;priority&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;socket&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据上述信息，可以知道如何构造一个具体的请求来触发后端的某个处理程序。</p><p>整体的<code>HTTP</code>请求处理流程大概如下。首先，请求通过<code>5000</code>端口发送给设备，基于请求的<code>url</code>，<code>nginx</code>服务会将该请求分发给不同的<code>cgi</code>，如<code>query.cgi</code>、<code>login.cgi</code>和<code>entry.cgi</code>，其中，<code>entry.cgi</code>是大部分<code>POST</code>请求的端点。这些<code>cgi</code>会与另外两个服务<code>synocgid</code>和<code>synoscgi</code>进行通信，其中<code>synocgid</code>负责处理与<code>session</code>相关的事务，而<code>synoscgi</code>则负责分发具体的请求到最终的处理程序。</p><img src="images/cq674350529_process_flow.png" style="zoom:60%"><h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><p>在理解了<code>HTTP</code>请求流程和处理机制后，便可以对群晖<code>NAS</code>设备的功能模块进行分析。在群晖<code>NAS</code>设备上，主要包含两大攻击面：<code>DSM</code>操作系统本身和群晖提供的大量套件。下面结合具体的实例进行分析。</p><h4 id="Diagnosis-Tool"><a href="#Diagnosis-Tool" class="headerlink" title="Diagnosis Tool"></a>Diagnosis Tool</h4><p>前面提到过，<code>Diagnosis Tool</code>是群晖提供的一个工具套件，支持抓包、调试等功能。该工具的界面和具体的抓包请求示例如下。</p><img src="images/cq674350529_diagnosis_tool_ui.png" style="zoom:80%"><p>该请求由<code>packet_capture.cgi</code>程序进行处理，部分示例代码如下。在<code>handle_action_start()</code>中，获取请求中的参数后将其以<code>json</code>字符串的形式传给<code>tcpdump_wrapper</code>程序。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">handle_action_start</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">const</span> <span class="keyword">char</span> *a3, <span class="keyword">const</span> <span class="keyword">char</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Json::Value::Value((Json::Value *)&amp;v39, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v28);</span><br><span class="line">  v17 = Json::Value::<span class="keyword">operator</span>[](&amp;v35, <span class="string">&quot;output_dir&quot;</span>);</span><br><span class="line">  Json::Value::<span class="keyword">operator</span>=(v17, &amp;v39);</span><br><span class="line">  Json::Value::~Value((Json::Value *)&amp;v39);</span><br><span class="line">  Json::Value::Value((Json::Value *)&amp;v40, v4);</span><br><span class="line">  v18 = Json::Value::<span class="keyword">operator</span>[](&amp;v35, <span class="string">&quot;expression&quot;</span>);</span><br><span class="line">  Json::Value::<span class="keyword">operator</span>=(v18, &amp;v40);</span><br><span class="line">  Json::Value::~Value((Json::Value *)&amp;v40);</span><br><span class="line">  Json::Value::Value((Json::Value *)&amp;v41, v6);</span><br><span class="line">  v19 = Json::Value::<span class="keyword">operator</span>[](&amp;v35, <span class="string">&quot;interface&quot;</span>);</span><br><span class="line">  Json::Value::<span class="keyword">operator</span>=(v19, &amp;v41);</span><br><span class="line">  Json::Value::~Value((Json::Value *)&amp;v41);</span><br><span class="line">  Json::FastWriter::write((Json::FastWriter *)&amp;v33, (<span class="keyword">const</span> Json::Value *)&amp;v37);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v29, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v33);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (SLIBCExec(<span class="string">&quot;/var/packages/DiagnosisTool/target/bin/tcpdump_wrapper&quot;</span>, <span class="string">&quot;--params&quot;</span>, v29, <span class="number">0L</span>L, <span class="number">0L</span>L) == <span class="number">-1</span> )</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>在<code>tcpdump_wrapper</code>中，调用<code>sub_401F10()</code>解析得到<code>output_dir</code>、<code>expression</code>和<code>interface</code>参数，并传入<code>RunTcpDump()</code>，其最终调用<code>execve()</code>执行命令<code>tcpdump -i &lt;interface&gt; -w &lt;file&gt; -C 10 -s 0 filter_expression</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ( v3 != <span class="number">2</span> &amp;&amp; !<span class="built_in">strcmp</span>(v4[<span class="number">1</span>], <span class="string">&quot;--params&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v11, v4[<span class="number">2</span>], &amp;v6);</span><br><span class="line">      <span class="comment">// resolve parameters from json string</span></span><br><span class="line">      sub_401F10(&amp;v11, &amp;output_dir, &amp;expression,&amp;interface);</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sub_4019D0(&amp;output_dir) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (sub_401900() &amp;&amp; !RunTcpdump(&amp;output_dir, &amp;expression, &amp;interface) )</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="comment">// ... </span></span><br></pre></td></tr></table></figure><p>调用<code>execve()</code>来执行命令，相对比较安全，避免了命令注入的问题，但其中的<code>filter_expression</code>参数是可控的。通过查看<code>tcpdump</code>命令的帮助文档，发现<code>-z</code>选项与<code>-C</code>或<code>-G</code>选项组合也可达到命令执行的目的。</p><img src="images/cq674350529_tcpdump_man.png"><p>针对<code>tcpdump -i &lt;interface&gt; -w &lt;file&gt; -C 10 -s 0 filter_expression</code>，其中已包含<code>-C</code>选项，因此通过伪造<code>filter_expression</code>参数为<code>-z&lt;path to your shell script&gt;</code>，即通过注入命令选项，可实现命令执行的效果。</p><h4 id="DS-File"><a href="#DS-File" class="headerlink" title="DS File"></a>DS File</h4><p><code>DS File</code>是群晖提供的一个移动应用程序，便于从移动设备上访问和管理<code>DiskStation</code>上的文件，使用该应用访问<code>DiskStation</code>的流程与通过<code>web</code>的流程类似。当尝试登录到<code>DiskStation</code>时，认证过程采用基于<code>PKI</code>的加密机制。而在某些情形下如目标<code>IP</code>输入错误，或者网络临时不可用，正常的请求会失败，<code>DS File</code>会发送额外的请求。</p><img src="images/cq674350529_Ds_File_access_flow.png" style="zoom:60%"><p>通过查看对应的第<code>3</code>个请求发现，在请求头中包含经过<code>Base64</code>编码后的<code>Authorization</code>信息，相当于明文。</p><img src="images/cq674350529_ds_file_password_leakage.png" style="zoom:65%"><p>因此，在一个不安全的网络环境中，当尝试通过<code>DS File</code>应用访问<code>DiskStation</code>时，通过简单地丢弃或重定向对应的请求，”中间人’’可窃取用户的明文账号信息。</p><h4 id="Synology-Calendar"><a href="#Synology-Calendar" class="headerlink" title="Synology Calendar"></a>Synology Calendar</h4><p>该套件是一个基于<code>Web</code>的应用程序，用于管理日常的事件和任务，其支持在事件中添加附件和分享日程等功能。其中，添加附件的功能支持从本地上传和从 <code>NAS</code>中上传两种方式。普通用户创建事件并添加附件的示例如下，同时给出了与附件链接相关的部分前端代码。</p><img src="images/cq674350529_calendar_event_attachment.png" style="zoom:60%"><p>可以看到，上传文件的名称被拼接到<code>href</code>链接中。如果伪造一个文件名，能否控制对应的<code>href</code>链接呢？经过测试发现，由于未对文件名进行校验，通过伪造一个合适的文件名，可以更改对应的<code>href</code>链接，同时让显示的文件名称看起来正常。</p><img src="images/cq674350529_calendar_csrf.png" style="zoom:60%"><p>此外，借助日程分享功能，还可以将该事件分享到管理员组中。当管理员组中的某个人查看该事件并点击对应的附件之后，该请求就会被执行。因此，利用该漏洞，一个普通权限的用户可以以”管理员”的权限执行”任意”请求，比如将其添加到管理员组中。</p><h4 id="Media-Server"><a href="#Media-Server" class="headerlink" title="Media Server"></a>Media Server</h4><p><code>Media Server</code>套件提供与多媒体相关的服务，允许在<code>NAS</code>上通过<code>DLNA/UPnP</code>播放多媒体内容。在安装该套件后，会启动一些自定义的服务，如下。</p><img src="images/cq674350529_mediaserver_custom_service.png"><p>通过简单的分析，发现<code>dms</code>中存在一些可供访问的<code>url</code>，且无需认证。</p><img src="images/cq674350529_mediaserver_dms_urls.png" style="zoom:60%"><p>第<code>1</code>个比较有意思的<code>api</code>是<code>videotranscoding.cgi</code>，对应的请求<code>url</code>格式为<code>http://%s:%d/transcoder/videotranscoding.cgi/%s/id=%d%s</code>，处理该请求的部分代码如下。可以看到，如果<code>url</code>中包含字符串<code>id=</code>和字符<code>?</code>，就将<code>id=</code>和<code>?</code>之间的内容拷贝到<code>dest</code>缓冲区中。由于没有考虑两者出现的先后顺序，如果请求<code>url</code>为<code>http://%s:%d/transcoder/videotranscoding.cgi/VideoStation?id=1</code>，在调用<code>strncpy()</code>时就会出现整数下溢问题。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_406E80</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v4 = getenv(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(s, <span class="number">0x800</span>uLL, <span class="string">&quot;%s&quot;</span>, v4);</span><br><span class="line">  v99 = <span class="built_in">strstr</span>(s, <span class="string">&quot;id=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v99 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">strchr</span>(s, <span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      <span class="built_in">strncpy</span>(dest, v99 + <span class="number">3</span>, v5 - (v99 + <span class="number">3</span>)); <span class="comment">// integer underflow</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::assign(v3, dest, <span class="built_in">strlen</span>(dest));</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  sub_403F50(a1, v1, v3, (<span class="built_in">std</span>::<span class="built_in">string</span> *)(a1 + <span class="number">136</span>));</span><br></pre></td></tr></table></figure><p>假设请求<code>url</code>的格式和程序预期的一致，函数<code>sub_403F50()</code>将会在后续被调用，其第<code>3</code>个参数对应前面拷贝的请求<code>url</code>中<code>id=</code>和<code>?</code>之间的内容。在<code>sub_403F50()</code>中，对参数<code>a2</code>进行简单校验后，参数<code>a3</code>会被当做<code>id</code>后面的参数进行格式化。由于未对参数<code>a3</code>进行适当校验，且参数<code>a3</code>外部可控，因此会存在<code>SQL</code>注入的问题。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_403F50</span><span class="params">(__int64 a1, <span class="built_in">std</span>::<span class="built_in">string</span> *a2, _QWORD *a3, <span class="built_in">std</span>::<span class="built_in">string</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">std</span>::<span class="built_in">string</span>::compare(a2, <span class="string">&quot;MediaServer&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)v32, <span class="string">&quot;mediaserver&quot;</span>, <span class="number">0xB</span>uLL);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v34, <span class="string">&quot;MediaServer&quot;</span>, <span class="number">0xB</span>uLL);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)v33, <span class="string">&quot;video&quot;</span>, <span class="number">5u</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">std</span>::<span class="built_in">string</span>::compare(a2, <span class="string">&quot;VideoStation&quot;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)v32, <span class="string">&quot;video_metadata&quot;</span>, <span class="number">0xE</span>uLL);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v34, <span class="string">&quot;VideoStation&quot;</span>, <span class="number">0xC</span>uLL);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)v33, <span class="string">&quot;video_file&quot;</span>, <span class="number">0xA</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">snprintf</span>(s, <span class="number">0x100</span>uLL, <span class="string">&quot;SELECT * from %s where id = %s&quot;</span>, v33[<span class="number">0</span>], (<span class="keyword">const</span> <span class="keyword">char</span> *)*a3); <span class="comment">// SQL injection</span></span><br></pre></td></tr></table></figure><p>另外<code>1</code>个类似的<code>api</code>为<code>jpegtnscaler.cgi</code>，对应的请求<code>url</code>格式为<code>http://%s:%d/transcoder/jpegtnscaler.cgi/%s/%d.%s</code>，处理该请求的部分代码如下。可以看到，在调用<code>strncpy()</code>前未对其长度参数进行校验，通过构造请求如<code>http://%s:%d/transcoder/jpegtnscaler.cgi/&lt;a*0x450&gt;/1</code>，可造成缓冲区溢出。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v3 = getenv(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v4 = <span class="built_in">strrchr</span>(v3, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  v5 = v4;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v6 = strtol(v4 + <span class="number">1</span>, <span class="number">0L</span>L, <span class="number">10</span>);</span><br><span class="line">  bzero(s, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="built_in">strncpy</span>(s, v3, v5 - v3);  <span class="comment">// buffer overflow</span></span><br></pre></td></tr></table></figure><h4 id="Audio-Station"><a href="#Audio-Station" class="headerlink" title="Audio Station"></a>Audio Station</h4><p><code>Audio Station</code>套件提供收听广播节目、管理音乐库、建立个人播放清单等功能，并支持随时随地与朋友分享。安装该套件后，在其安装路径下会存在一些自定义的<code>cgi</code>程序，如<code>media_server.cgi</code>、<code>web_player.cgi</code>、<code>audiotransfer.cgi</code>等。在使用该套件的同时进行抓包，部分请求示例如下。</p><img src="images/cq674350529_audiostation_request_example.png" style="zoom:80%"><p>在前面提到的<code>HTTP</code>请求处理流程中，<code>execl_cgi()</code>负责处理自定义的<code>cgi</code>请求。更重要的是，在某些情形下，认证的处理由自定义的<code>cgi</code>程序负责。</p><img src="images/cq674350529_audiostation_http_request.png" style="zoom:60%"><p>通过分析，最有意思的<code>api</code>为<code>audiotransfer.cgi</code>，对应的请求<code>url</code>格式为<code>http://%s:%d/webman/3rdparty/AudioStation/webUI/audiotransfer.cgi/%s.%s</code>，处理该请求的部分代码如下。可以看到，在<code>main()</code>函数开始处调用<code>sub_402730()</code>。在函数<code>sub_402730()</code>中，先获取请求<code>url</code>路径最后面的内容，然后将其传给<code>MediaIDDecryption()</code>。在<code>MediaIDDecryption()</code>中，先计算参数<code>a1</code>的长度，在拷贝前<code>6</code>个字节后，调用<code>snprintf()</code>。由于调用<code>snprintf()</code>时，其<code>size</code>参数和后面的字符串内容可控，存在缓冲区溢出问题。更重要的是，这个过程中没有对认证进行处理，即无需认证，因此通过构造并发送特定的请求，远程未认证的用户可触发该缓冲区溢出漏洞。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_402730((__int64)v5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">_BOOL8 <span class="title">sub_402730</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v8 = getenv(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(s, <span class="number">0x400</span>uLL, <span class="string">&quot;%s&quot;</span>, v8);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v11 = <span class="built_in">strrchr</span>(s, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  v12 = v11;</span><br><span class="line">  <span class="keyword">if</span> ( v11 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    v15 = MediaIDDecryption((__int64)(v12 + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">__int64 <span class="title">MediaIDDecryption</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v1 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (v1 - <span class="number">6</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(s, <span class="number">7u</span>LL, <span class="string">&quot;%s&quot;</span>, a1);</span><br><span class="line">    v14 = <span class="number">0</span>; v4 = s; v5 = (<span class="keyword">char</span> *)&amp;v14;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = *v4; --v5; ++v4; v5[<span class="number">6</span>] = v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 != &amp;v13 );   <span class="comment">// copy first 6 bytes</span></span><br><span class="line">    __isoc99_sscanf(s, <span class="string">&quot;%x&quot;</span>, &amp;v8);</span><br><span class="line">    __isoc99_sscanf(&amp;v14, <span class="string">&quot;%x&quot;</span>, &amp;v9);</span><br><span class="line">    <span class="built_in">snprintf</span>(v17, v3 + <span class="number">1</span>, <span class="string">&quot;%s&quot;</span>, a1 + <span class="number">6</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(v18, v3 + <span class="number">1</span>, <span class="string">&quot;%s&quot;</span>, &amp;a1[v3 + <span class="number">6</span>]); <span class="comment">// buffer overflow</span></span><br></pre></td></tr></table></figure><p>关于漏洞利用，知道创宇的<code>@fenix</code>师傅基于<code>DSM 5.2-5592</code>和<code>Audio Station 5.4-2860</code>进行了<span class="exturl" data-url="aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzE2MDQv">分析和测试<i class="fa fa-external-link-alt"></i></span>，其中相关的条件包括<code>x86架构</code>、<code>NX保护</code>、<code>ASLR为半随机</code>，感兴趣的可以去看看。这里补充几点：</p><ul><li><p>针对<code>x86</code>架构，基于<code>DSM 6.x</code>，<code>ASLR</code>为全随机，通过寻找合适的<code>gadgets</code>，可实现稳定利用，无需堆喷或爆破；</p></li><li><p>在<code>DSM 6.x</code>上，获取到<code>shell</code>后，还需要进行提权操作；</p></li><li><p>针对<code>x64</code>架构，由于存在地址高位截断的问题，暂时未找到合适的思路进行利用。</p><blockquote><p>如果师傅们有合适的思路，欢迎交流 :)</p></blockquote></li></ul><h3 id="One-More-Thing"><a href="#One-More-Thing" class="headerlink" title="One More Thing"></a>One More Thing</h3><p>上面只是列举了几个典型的套件，以及在其中发现的部分问题。实际上，群晖的<code>DSM</code>系统中有非常多的功能，以及大量的套件可供分析。群晖官方会不定期发布其产品的<span class="exturl" data-url="aHR0cHM6Ly93d3cuc3lub2xvZ3kuY29tL2VuLWdsb2JhbC9zZWN1cml0eS9hZHZpc29yeQ==">安全公告<i class="fa fa-external-link-alt"></i></span>，结合群晖的<span class="exturl" data-url="aHR0cHM6Ly9hcmNoaXZlLnN5bm9sb2d5LmNvbS9kb3dubG9hZC8=">镜像仓库<i class="fa fa-external-link-alt"></i></span>，可以很方便地去做补丁分析和漏洞挖掘。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>针对群晖<code>NAS</code>的远程使用场景，本文重点对<code>web</code>接口上请求的流程和处理机制进行了分析。同时，结合几个典型的套件，基于上述流程，分享了在其中发现的部分安全问题。</p><p>本文是该系列的最后一篇，希望对群晖<code>NAS</code>设备感兴趣的同学有所收获。</p><h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3lub2xvZ3kuY24vemgtY24vc2VjdXJpdHkvYWR2aXNvcnkvU3lub2xvZ3lfU0FfMjBfMDc=">Synology-SA-20:07 Synology Calendar<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3lub2xvZ3kuY24vemgtY24vc2VjdXJpdHkvYWR2aXNvcnkvU3lub2xvZ3lfU0FfMjFfMjE=">Synology-SA-21:21 Audio Station<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzE2MDQv">聊聊 Synology NAS Audio Station 套件未授权 RCE 调试及 EXP 构造<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3lub2xvZ3kuY29tL3poLWNuL3NlY3VyaXR5L2Fkdmlzb3J5">群晖产品安全公告<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9hcmNoaXZlLnN5bm9sb2d5LmNvbS9kb3dubG9hZC8=">群晖镜像仓库<i class="fa fa-external-link-alt"></i></span></li></ul><br><blockquote><p>本文首发于安全客，文章链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjY2Mjk3">https://www.anquanke.com/post/id/266297<i class="fa fa-external-link-alt"></i></span></p></blockquote></div><footer class="post-footer"><div class="reward-container"><div>你的支持是我最大的动力</div><button>赞赏</button><div class="post-reward"><div><img src="/uploads/wechatpay.png" alt="cq674350529 微信"> <span>微信</span></div></div></div><div class="post-tags"><a href="/tags/Synology/" rel="tag"># Synology</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/12/25/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E4%B8%89-iscsi_snapshot_comm_core%E6%9C%8D%E5%8A%A1%E5%88%86%E6%9E%90/" rel="prev" title="A Journey into Synology NAS 系列三: iscsi_snapshot_comm_core服务分析"><i class="fa fa-chevron-left"></i> A Journey into Synology NAS 系列三: iscsi_snapshot_comm_core服务分析</a></div><div class="post-nav-item"><a href="/2023/01/06/Patch-diff-an-old-vulnerability-in-Synology-NAS/" rel="next" title="Patch diff an old vulnerability in Synology NAS">Patch diff an old vulnerability in Synology NAS <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">cq674350529</span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"waline-blog-alpha.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"locale":{"placeholder":"欢迎评论, 填上邮箱可以收到回复邮件 :)"},"avatar":"mm","meta":["nick","mail"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2022/01/22/A-Journey-into-Synology-NAS-%E7%B3%BB%E5%88%97%E5%9B%9B-HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%92%8C%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script></body></html>